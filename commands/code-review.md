---
description: Odoo 19 ä»£ç å®¡æŸ¥å‘½ä»¤ - å…¨é¢å®¡æŸ¥æœªæäº¤çš„æ›´æ”¹ï¼Œæ£€æŸ¥ PEP8 åˆè§„æ€§ã€Odoo ç¼–ç æ ‡å‡†ã€API è£…é¥°å™¨ä½¿ç”¨ã€é”™è¯¯å¤„ç†å’Œæ¡†æ¶åˆè§„æ€§ã€‚
---

# Odoo 19 Code Review å‘½ä»¤

æ­¤å‘½ä»¤è°ƒç”¨ **code-reviewer** agent å¯¹æœªæäº¤çš„ Odoo ä»£ç æ›´æ”¹è¿›è¡Œå…¨é¢çš„å®‰å…¨å’Œè´¨é‡å®¡æŸ¥ã€‚

## å‘½ä»¤åŠŸèƒ½

1. **è·å–æ›´æ”¹æ–‡ä»¶** - æŸ¥çœ‹æœ€è¿‘çš„ git diff
2. **åˆ†æ Odoo æ–‡ä»¶** - èšç„¦ä¿®æ”¹çš„ Pythonã€XMLã€JavaScript æ–‡ä»¶
3. **ç«‹å³å¼€å§‹å®¡æŸ¥** - æ ¹æ® Odoo 19 æ ‡å‡†è¯„ä¼°ä»£ç è´¨é‡

## ä½¿ç”¨åœºæ™¯

å½“ä»¥ä¸‹æƒ…å†µæ—¶ä½¿ç”¨ `/code-review`ï¼š
- åˆšç¼–å†™/ä¿®æ”¹äº† Odoo ä»£ç 
- å‡†å¤‡æäº¤ä»£ç æ›´æ”¹
- å®Œæˆ Odoo åŠŸèƒ½å¼€å‘
- ä¿®å¤äº† Odoo bug
- é‡æ„äº† Odoo ä»£ç 

## å·¥ä½œæµç¨‹

1. è¿è¡Œ `git diff --name-only HEAD` æŸ¥çœ‹æ›´æ”¹çš„æ–‡ä»¶
2. å¯¹æ¯ä¸ªæ›´æ”¹çš„æ–‡ä»¶æ£€æŸ¥ï¼š
   - å®‰å…¨é—®é¢˜ï¼ˆCRITICALï¼‰
   - ä»£ç è´¨é‡ï¼ˆHIGHï¼‰
   - æœ€ä½³å®è·µï¼ˆMEDIUMï¼‰
3. ç”ŸæˆåŒ…å«ä¸¥é‡æ€§ã€ä½ç½®ã€æè¿°å’Œä¿®å¤å»ºè®®çš„æŠ¥å‘Š

## Odoo 19 å®¡æŸ¥æ£€æŸ¥æ¸…å•

### å…³é”®é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

#### å®‰å…¨é—®é¢˜
- **ç¡¬ç¼–ç å‡­æ®**ï¼ˆAPI å¯†é’¥ã€å¯†ç ã€ä»¤ç‰Œï¼‰
  ```python
  # æ£€æŸ¥: grep -r "api_key\|password\|secret\|token" --include="*.py" .
  ```
- **SQL æ³¨å…¥é£é™©**ï¼ˆæŸ¥è¯¢ä¸­çš„å­—ç¬¦ä¸²è¿æ¥ï¼‰
- **ç¼ºå°‘è®¿é—®æƒé™**ï¼ˆæ²¡æœ‰ ir.model.access.csv æ¡ç›®ï¼‰
- **ç¼ºå°‘è®°å½•è§„åˆ™**ï¼ˆç”¨äºå¤šç”¨æˆ·æ¨¡å‹ï¼‰
- **ç»•è¿‡å®‰å…¨**ï¼ˆæ²¡æœ‰ç†ç”±çš„ sudo()ï¼‰
- **ç¼ºå°‘ CSRF ä¿æŠ¤**åœ¨ HTTP è·¯ç”±ä¸Š
- **æš´éœ²å†…éƒ¨æ•°æ®**åœ¨ API å“åº”ä¸­

#### æ¡†æ¶åˆè§„æ€§
- **é”™è¯¯çš„ Python ç‰ˆæœ¬**ï¼ˆOdoo 19 åº”ä¸º Python 3.10+ï¼‰
- **æ¨¡å‹å®šä¹‰ä¸­ç¼ºå°‘ _name**
- **é”™è¯¯çš„ç»§æ‰¿**ï¼ˆ_inherit vs _inheritsï¼‰
- **é”™è¯¯çš„ ORM æ–¹æ³•ä½¿ç”¨**ï¼ˆå¯¹å•æ¡è®°å½•ä½¿ç”¨ search è€Œä¸æ˜¯ browseï¼‰
- **éœ€è¦çš„åœ°æ–¹ç¼ºå°‘ @api è£…é¥°å™¨**

### é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆåº”è¯¥ä¿®å¤ï¼‰

#### ä»£ç è´¨é‡
- **PEP8 è¿è§„**ï¼ˆè¿è¡Œ: `pylint your_module --py3k`ï¼‰
  - è¡Œé•¿åº¦ > 100 å­—ç¬¦ï¼ˆOdoo åå¥½ï¼Œä¸æ˜¯ 79ï¼‰
  - è¿ç®—ç¬¦å‘¨å›´ç¼ºå°‘ç©ºæ ¼
  - å¯¼å…¥ä¸ä¸€è‡´
- **å¤§å‡½æ•°**ï¼ˆOdoo ä¸­ >50 è¡Œï¼‰
- **å¤§æ–‡ä»¶**ï¼ˆ>800 è¡Œï¼‰
- **æ·±åº¦åµŒå¥—**ï¼ˆ>4 å±‚ï¼‰
- **ç¼ºå°‘æ–‡æ¡£å­—ç¬¦ä¸²**åœ¨å…¬å…±æ–¹æ³•ä¸Š
- **å‘½åä¸å½“**ï¼ˆå•ä¸ªå­—æ¯ã€æ²¡æœ‰ä¸Šä¸‹æ–‡çš„ç¼©å†™ï¼‰

#### Odoo ç‰¹å®šé—®é¢˜
- **éœ€è¦æ—¶ä½¿ç”¨ @api.multi**
- **onchange ä½¿ç”¨é”™è¯¯**ï¼ˆå¤šå­—æ®µæ²¡æœ‰è¿”å›ï¼‰
- **è¦†ç›–ä¸­ç¼ºå°‘ super()**
- **ç›´æ¥ SQL æŸ¥è¯¢**æ²¡æœ‰ç†ç”±
- **é”™è¯¯çš„ XML ç»“æ„**
  - é»˜è®¤æ•°æ®ç¼ºå°‘ `noupdate="1"`
  - é‡å¤çš„ XML ID
  - ä¸æ­£ç¡®çš„è§†å›¾ arch ç»“æ„
- **é¢‘ç¹æœç´¢å­—æ®µç¼ºå°‘ç´¢å¼•**
- **é”™è¯¯çš„åŸŸè¯­æ³•**ï¼ˆå…ƒç»„ vs åˆ—è¡¨ï¼‰
- **é”™è¯¯çš„è®¡ç®—å­—æ®µ**ï¼ˆç¼ºå°‘ @api.dependsï¼‰

#### é”™è¯¯å¤„ç†
- **é™é»˜å¤±è´¥**ï¼ˆå¸¦æœ‰ç©º except çš„ try/exceptï¼‰
- **é€šç”¨å¼‚å¸¸**ï¼ˆè£¸ `except:` æˆ– `except Exception:`ï¼‰
- **ç¼ºå°‘ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯**
- **æ§åˆ¶å™¨ä¸­æœªæ•è·çš„å¼‚å¸¸**

### ä¸­ç­‰ä¼˜å…ˆçº§é—®é¢˜ï¼ˆè€ƒè™‘ä¿®å¤ï¼‰

#### æ€§èƒ½
- **N+1 æŸ¥è¯¢**ï¼ˆå¾ªç¯å†…æœç´¢ï¼‰
  ```python
  # âŒ Bad: N+1 queries
  for order in orders:
      partner = order.partner_id.name  # è§¦å‘æŸ¥è¯¢

  # âœ… Good: é¢„å– with browse
  for order in orders:
      partner = order.partner_id.name  # å·²é¢„å–
  ```
- **å…³ç³»å­—æ®µç¼ºå°‘å»¶è¿ŸåŠ è½½**
- **å¾ªç¯ä¸­ä¸å¿…è¦çš„è®¡ç®—**
- **å¤§æ•°æ®é›†æ²¡æœ‰ limit/offset**
- **è¿æ¥å­—æ®µç¼ºå°‘ç´¢å¼•**

#### å‰ç«¯ï¼ˆJavaScript/OWLï¼‰
- **ç¼ºå°‘ç¿»è¯‘**ï¼ˆæ²¡æœ‰ `_t()` åŒ…è£…å­—ç¬¦ä¸²ï¼‰
- **ç›´æ¥ DOM æ“ä½œ**ï¼ˆä½¿ç”¨ OWL æ¡†æ¶ï¼‰
- **å¼‚æ­¥æ“ä½œç¼ºå°‘é”™è¯¯å¤„ç†**
- **ç¡¬ç¼–ç å­—ç¬¦ä¸²**ï¼ˆåº”ä½¿ç”¨æ¨¡æ¿ï¼‰
- **æ ·å¼ä¸ä¸€è‡´**ï¼ˆä½¿ç”¨ QWeb æ¨¡æ¿ï¼‰

#### æµ‹è¯•
- **æ–°ä»£ç ç¼ºå°‘æµ‹è¯•**
- **ä¸å¯é æµ‹è¯•**ï¼ˆæ—¶é—´ä¾èµ–ã€é¡ºåºä¾èµ–ï¼‰
- **æ…¢æµ‹è¯•**ï¼ˆå¤–éƒ¨æœåŠ¡ä½¿ç”¨æ¨¡æ‹Ÿï¼‰
- **ä¿®æ”¹æ•°æ®åº“çš„æµ‹è¯•**æ²¡æœ‰æ¸…ç†

### ä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆå¥½çš„åšæ³•ï¼‰

- **TODO/FIXME** æ²¡æœ‰ç¥¨æ®
- **ç¼ºå°‘ç±»å‹æç¤º**ï¼ˆOdoo ä¸­ä¸è¦æ±‚ä½†å¾ˆå¥½ï¼‰
- **æ ¼å¼ä¸ä¸€è‡´**ï¼ˆä½¿ç”¨ black/autopep8ï¼‰
- **è¯¦ç»†æ³¨é‡Š**ï¼ˆä»£ç åº”è¯¥è‡ªæ–‡æ¡£åŒ–ï¼‰
- **æœªä½¿ç”¨çš„å¯¼å…¥**ï¼ˆè¿è¡Œ: `pylint --disable=all --enable=unused-import`ï¼‰

## Odoo 19 ç‰¹å®šå®¡æŸ¥æ¨¡å¼

### æ¨¡å‹å®¡æŸ¥
```python
class MyModel(models.Model):
    _name = 'my.model'  # âœ… æ­£ç¡®çš„å‘½å
    _description = 'My Model'
    _order = 'date_create desc'  # âœ… é»˜è®¤æ’åº

    name = fields.Char(required=True, string="Name")
    # âœ… ç”¨äºç¿»è¯‘çš„ string å‚æ•°
    # âœ… å…³é”®å­—æ®µ required
```

æ£€æŸ¥:
- [ ] `_name` éµå¾ª `module.model_name` æ ¼å¼
- [ ] `_description` å·²è®¾ç½®ä¸”å¯ç¿»è¯‘
- [ ] å­—æ®µæœ‰æ­£ç¡®çš„ `string` å±æ€§
- [ ] å¿…éœ€å­—æ®µæ­£ç¡®æ ‡è®°
- [ ] è®¡ç®—å­—æ®µæœ‰ `@api.depends`
- [ ] çº¦æŸæ­£ç¡®å®šä¹‰

### XML è§†å›¾å®¡æŸ¥
```xml
<!-- âœ… æ­£ç¡®çš„è§†å›¾ç»“æ„ -->
<record id="view_my_model_form" model="ir.ui.view">
    <field name="name">my.model.form</field>
    <field name="model">my.model</field>
    <field name="arch" type="xml">
        <form string="My Model">
            <sheet>
                <group>
                    <field name="name"/>
                    <!-- âœ… éœ€è¦æ—¶æ­£ç¡®çš„å°éƒ¨ä»¶ -->
                    <field name="date" widget="date"/>
                </group>
            </sheet>
        </form>
    </field>
</record>
```

æ£€æŸ¥:
- [ ] XML ID éµå¾ª `module.view_name` æ ¼å¼
- [ ] è§†å›¾ç±»å‹åŒ¹é…ç›®çš„ï¼ˆformã€treeã€kanbanï¼‰
- [ ] å­—æ®µå¼•ç”¨åœ¨æ¨¡å‹ä¸­å­˜åœ¨
- [ ] é»˜è®¤æ•°æ®ä¸Šçš„ Noupdate="1"
- [ ] æ²¡æœ‰é‡å¤çš„ XML ID

### æ§åˆ¶å™¨å®¡æŸ¥
```python
class MyController(http.Controller):
    @http.route('/my/endpoint', type='json', auth='user')
    def my_endpoint(self, **kwargs):
        # âœ… æ­£ç¡®çš„ auth å‚æ•°
        # âœ… ç”¨äº API çš„ JSON ç±»å‹
        return {'result': 'success'}
```

æ£€æŸ¥:
- [ ] æ­£ç¡®çš„ `auth` å‚æ•°ï¼ˆpublic/user/user_api_keyï¼‰
- [ ] è¡¨å•çš„ CSRF ä¿æŠ¤
- [ ] è¾“å…¥éªŒè¯
- [ ] é”™è¯¯å¤„ç†
- [ ] æ­£ç¡®çš„å“åº”æ ¼å¼

## å®¡æŸ¥æŠ¥å‘Šæ ¼å¼

```markdown
## Odoo ä»£ç å®¡æŸ¥æŠ¥å‘Š

**æ–‡ä»¶:** [æ›´æ”¹çš„æ–‡ä»¶åˆ—è¡¨]
**å®¡æŸ¥æ—¥æœŸ:** YYYY-MM-DD
**å®¡æŸ¥è€…:** code-reviewer agent

### æ‘˜è¦
- **å…³é”®:** X
- **é«˜:** Y
- **ä¸­:** Z
- **ä½:** W
- **æ€»ä½“:** ğŸ”´ é˜»å¡ / âš ï¸ è­¦å‘Š / âœ… æ‰¹å‡†

### å…³é”®é—®é¢˜ï¼ˆç«‹å³ä¿®å¤ï¼‰

#### 1. SQL æ³¨å…¥é£é™©
**ä¸¥é‡æ€§:** CRITICAL
**æ–‡ä»¶:** models/my_model.py:45
**é—®é¢˜:** SQL æŸ¥è¯¢ä¸­çš„å­—ç¬¦ä¸²è¿æ¥

**ä»£ç :**
```python
query = "SELECT * FROM table WHERE id = " + str(id)
self.env.cr.execute(query)
```

**å½±å“:** æ½œåœ¨çš„ SQL æ³¨å…¥æ¼æ´å…è®¸ä»»æ„ SQL æ‰§è¡Œã€‚

**ä¿®å¤:**
```python
# ä½¿ç”¨ ORM ä»£æ›¿
records = self.env['table'].search([('id', '=', id)])
```

#### 2. ç¼ºå°‘è®¿é—®æƒé™
**ä¸¥é‡æ€§:** CRITICAL
**æ–‡ä»¶:** security/ir.model.access.csv
**é—®é¢˜:** my.model æ²¡æœ‰å®šä¹‰è®¿é—®æƒé™

**å½±å“:** ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰æ— æ³•è®¿é—®æ¨¡å‹ã€‚

**ä¿®å¤:**
æ·»åŠ åˆ° ir.model.access.csv:
```csv
access_my_model_user,model_my_model,base.group_user,1,1,1,1
access_my_model_manager,model_my_model,my_module.group_manager,1,1,1,1
```

### é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆç”Ÿäº§å‰ä¿®å¤ï¼‰

#### 1. PEP8 è¿è§„
**ä¸¥é‡æ€§:** HIGH
**æ–‡ä»¶:** models/my_model.py:23
**é—®é¢˜:** è¡Œé•¿åº¦è¶…è¿‡ 100 å­—ç¬¦

**ä»£ç :**
```python
result = self.env['another.model'].search([('field1', '=', value1), ('field2', '=', value2), ('field3', '=', value3)])
```

**ä¿®å¤:**
```python
result = self.env['another.model'].search([
    ('field1', '=', value1),
    ('field2', '=', value2),
    ('field3', '=', value3),
])
```

### ä¸­ç­‰ä¼˜å…ˆçº§é—®é¢˜

#### 1. N+1 æŸ¥è¯¢é—®é¢˜
**ä¸¥é‡æ€§:** MEDIUM
**æ–‡ä»¶:** controllers/controller.py:45
**é—®é¢˜:** å¾ªç¯å†…æœç´¢å¯¼è‡´ N+1 æŸ¥è¯¢

**ä»£ç :**
```python
for order in orders:
    partner = order.partner_id.name  # æ¯æ¬¡è§¦å‘æŸ¥è¯¢
```

**ä¿®å¤:**
```python
# ä¼™ä¼´è‡ªåŠ¨é¢„å–
for order in orders:
    partner = order.partner_id.name
```

### ä½ä¼˜å…ˆçº§é—®é¢˜

#### 1. ç¼ºå°‘æ–‡æ¡£å­—ç¬¦ä¸²
**ä¸¥é‡æ€§:** LOW
**æ–‡ä»¶:** models/my_model.py:67
**é—®é¢˜:** å…¬å…±æ–¹æ³•ç¼ºå°‘æ–‡æ¡£å­—ç¬¦ä¸²

**ä¿®å¤:**
```python
def calculate_total(self):
    """è®¡ç®—æ­¤è®°å½•çš„æ€»å€¼ã€‚

    Returns:
        float: è®¡ç®—å‡ºçš„æ€»è®¡
    """
```

## Odoo æ¡†æ¶æ£€æŸ¥

- [ ] Python 3.10+ å…¼å®¹æ€§
- [ ] PEP8 åˆè§„æ€§
- [ ] æ‰€æœ‰æ¨¡å‹æœ‰ `_name` å’Œ `_description`
- [ ] æ‰€æœ‰å­—æ®µæœ‰ `string` ç”¨äºç¿»è¯‘
- [ ] è®¡ç®—å­—æ®µæœ‰ `@api.depends`
- [ ] security/ ä¸­å®šä¹‰çš„è®¿é—®æƒé™
- [ ] å¤šç”¨æˆ·æ•°æ®çš„è®°å½•è§„åˆ™
- [ ] XML è§†å›¾éµå¾ª Odoo ç»“æ„
- [ ] æ§åˆ¶å™¨æœ‰æ­£ç¡®çš„ `auth` å‚æ•°
- [ ] å¤–éƒ¨ API è°ƒç”¨æœ‰é”™è¯¯å¤„ç†
- [ ] æ²¡æœ‰ç¡¬ç¼–ç å‡­æ®
- [ ] æ–°åŠŸèƒ½çš„æµ‹è¯•

## æ‰¹å‡†æ ‡å‡†

- âœ… **æ‰¹å‡†**: æ²¡æœ‰å…³é”®æˆ–é«˜ä¼˜å…ˆçº§é—®é¢˜
- âš ï¸ **è­¦å‘Š**: åªæœ‰ä¸­ç­‰ä¼˜å…ˆçº§é—®é¢˜ï¼ˆå¯ä»¥è°¨æ…åˆå¹¶ï¼‰
- âŒ **é˜»å¡**: å‘ç°å…³é”®æˆ–é«˜ä¼˜å…ˆçº§é—®é¢˜
```

## Odoo 19 å¸¸è§é”™è¯¯

### 1. sudo() ä½¿ç”¨é”™è¯¯
```python
# âŒ é”™è¯¯: sudo ç»•è¿‡å®‰å…¨æ£€æŸ¥
def action_approve(self):
    self.sudo().write({'state': 'approved'})

# âœ… æ­£ç¡®: åªåœ¨å¿…è¦æ—¶ä½¿ç”¨ sudo
def action_technical_cleanup(self):
    # ä¸åº”è¢«è®¿é—®æƒé™é˜»æ­¢çš„æŠ€æœ¯æ¸…ç†
    self.sudo().action_cleanup()
```

### 2. ç¼ºå°‘ onchange è¿”å›
```python
# âŒ é”™è¯¯: onchange ä»€ä¹ˆéƒ½ä¸è¿”å›
@api.onchange('product_id')
def _onchange_product_id(self):
    self.price = self.product_id.list_price

# âœ… æ­£ç¡®: ä¸ºå¤šä¸ªå­—æ®µè¿”å›å­—å…¸
@api.onchange('product_id')
def _onchange_product_id(self):
    return {
        'value': {
            'price': self.product_id.list_price,
        }
    }
```

### 3. åŸŸè¯­æ³•é”™è¯¯
```python
# âŒ é”™è¯¯: å…ƒç»„è€Œä¸æ˜¯åˆ—è¡¨
domain = (('field', '=', value),)

# âœ… æ­£ç¡®: å…ƒç»„åˆ—è¡¨
domain = [('field', '=', value)]
```

## Odoo ä»£ç å®¡æŸ¥å·¥å…·

```bash
# PEP8 æ£€æŸ¥
pylint odoo_module --py3k

# Python æ ¼å¼æ£€æŸ¥
black --check odoo_module

# å®‰å…¨é—®é¢˜æ£€æŸ¥
grep -r "sudo()" odoo_module/
grep -r "execute(" odoo_module/

# æ£€æŸ¥ç¼ºå°‘ç¿»è¯‘
grep -r '"[^"]*"' odoo_module/ | grep -v "_t("

# æ£€æŸ¥ç¡¬ç¼–ç å€¼
grep -rE "(api_key|password|secret|token)" odoo_module/
```

## ä¸å…¶ä»–å‘½ä»¤çš„é›†æˆ

- ä½¿ç”¨ `/plan` é¦–å…ˆè§„åˆ’å®ç°
- ä½¿ç”¨ `/tdd` ä»¥æµ‹è¯•é©±åŠ¨æ–¹å¼å®æ–½
- ä½¿ç”¨ `/code-review` å®¡æŸ¥å®Œæˆçš„å®æ–½
- ä½¿ç”¨ `/security-review` è¿›è¡Œå®‰å…¨å®¡æŸ¥

## ç›¸å…³ Agent

æ­¤å‘½ä»¤è°ƒç”¨ä½äºä»¥ä¸‹ä½ç½®çš„ `code-reviewer` agentï¼š
`~/.claude/agents/code-reviewer.md`

## è®°ä½

Odoo ä»£ç è´¨é‡å¯¹ç¨³å®šæ€§ã€å®‰å…¨æ€§å’Œå¯å‡çº§æ€§è‡³å…³é‡è¦ã€‚éµå¾ªæ¡†æ¶çº¦å®šï¼Œç¼–å†™æµ‹è¯•ï¼Œå¹¶å§‹ç»ˆè€ƒè™‘å¤šç”¨æˆ·ã€å¤šå…¬å¸åœºæ™¯ã€‚
